<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kinglian.screeninquiry.dao.DoctorOperationMapper">

    <resultMap id="HistoryOrderRep" type="com.kinglian.screeninquiry.model.dto.HistoryOrderRep">
        <result column="visit_date" property="visitiDate"/>
        <result column="visitid" property="visitiId"/>
        <result column="visit_status" property="visitiStauts"/>
        <result column="drugstoreid" property="drugStoreId"/>
        <result column="drugstore_name" property="drugstoreName"/>
        <result column="patientid" property="patientId"/>
        <result column="birthday" property="birthDay"/>
        <result column="sex" property="sex"/>
        <result column="member_name" property="patientName"/>
        <result column="new_user" property="patientType"/>
        <result column="diagnosis" property="diagnosis"/>
        <result column="total_price" property="totalCost"/>
    </resultMap>

    <select id="selectHistoryOrder" resultMap="HistoryOrderRep">
        SELECT
        b.*,
        mops.total_price
        FROM
        (
        SELECT
        a.*,
        momr.diagnosis
        FROM
        (
        SELECT
        mov.*,
        mpi.birthday,
        mpi.sex,
        mpi.member_name,
        mpi.new_user
        FROM
        (
        SELECT
        visit_date,
        visitid,
        visit_status,
        drugstoreid,
        drugstore_name,
        patientid
        FROM
        med_office_visit
        WHERE
        cdid = #{doctorId}
        <if test="beginTime != null and beginTime !=''" >
        AND visit_date <![CDATA[ >= ]]> #{beginTime}
        </if>
        <if test="endTime != null and endTime !=''">
        AND visit_date <![CDATA[ <= ]]> #{endTime}
        </if>
        <if test="type != null and type !=''">
        AND visit_status = #{type}
        </if>
        <if test="drugstoreName != null and drugstoreName !=''">
        AND drugstore_name like CONCAT('%', #{drugstoreName}, '%')
        </if>
        ) mov
        LEFT JOIN med_patient_info mpi ON mov.patientid = mpi.id
        WHERE
        mpi.deleted = '0'
        <if test="patientType != null and patientType !=''">
            AND mpi.new_user = #{patientType}
        </if>
        <if test="patientName != null and patientName !=''">
        AND mpi.member_name LIKE CONCAT('%', #{patientName}, '%')
        </if>
        ) a
        LEFT JOIN med_ov_medical_record momr ON a.visitid = momr.visitid
        ) b
        LEFT JOIN med_ov_pres_sheet mops ON b.visitid = mops.visitid
    </select>

</mapper>
